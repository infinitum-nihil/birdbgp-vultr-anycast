#!/bin/bash
# Script to fix web access to lg.infinitum-nihil.com
# Created by Claude

# Source .env file to get SSH key path
source "$(dirname "$0")/.env"

# LAX server IP
LAX_IP="149.248.2.74"

echo "Fixing web access configuration on LAX server ($LAX_IP)..."
ssh -o StrictHostKeyChecking=no -i "$SSH_KEY_PATH" root@$LAX_IP << 'EOF'
# Allow web traffic through the firewall
echo "Configuring firewall to allow web traffic..."
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow 8001/tcp

# Allow traffic on all interfaces, including dummy0 for anycast IP
ufw allow in on dummy0
ufw allow in on enp1s0

# Reload UFW
ufw reload

# Check UFW status
echo "Firewall status:"
ufw status

# Check if nginx or traefik is installed for port forwarding
if command -v nginx >/dev/null 2>&1; then
  echo "nginx is installed, configuring port forwarding..."
  
  # Create a simple nginx config to forward traffic to port 8001
  cat > /etc/nginx/sites-available/hyperglass << 'EOC'
server {
    listen 80;
    listen [::]:80;
    server_name _;  # Catch all hostnames

    location / {
        proxy_pass http://localhost:8001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
EOC

  # Enable the site
  ln -sf /etc/nginx/sites-available/hyperglass /etc/nginx/sites-enabled/
  
  # Test and restart nginx
  nginx -t && systemctl restart nginx
elif command -v docker >/dev/null 2>&1; then
  echo "Setting up nginx in Docker for port forwarding..."
  
  # Create a directory for nginx config
  mkdir -p /opt/nginx-proxy/conf.d
  
  # Create nginx config
  cat > /opt/nginx-proxy/conf.d/default.conf << 'EOC'
server {
    listen 80;
    listen [::]:80;
    server_name _;  # Catch all hostnames

    location / {
        proxy_pass http://localhost:8001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
EOC

  # Run nginx in Docker
  docker run -d --name nginx-proxy \
    --network=host \
    -v /opt/nginx-proxy/conf.d:/etc/nginx/conf.d \
    --restart=unless-stopped \
    nginx:alpine
else
  echo "Neither nginx nor docker found for port forwarding. Installing nginx..."
  apt-get update && apt-get install -y nginx
  
  # Create a simple nginx config to forward traffic to port 8001
  cat > /etc/nginx/sites-available/hyperglass << 'EOC'
server {
    listen 80;
    listen [::]:80;
    server_name _;  # Catch all hostnames

    location / {
        proxy_pass http://localhost:8001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
EOC

  # Enable the site
  ln -sf /etc/nginx/sites-available/hyperglass /etc/nginx/sites-enabled/
  
  # Test and restart nginx
  nginx -t && systemctl restart nginx
fi

# Verify port 80 is now listening
echo "Checking listening ports:"
netstat -tulpn | grep -E ':(80|443|8001)'

# Check if the anycast IP is properly attached to the dummy interface
echo "Checking anycast IP configuration:"
ip addr show dev dummy0 | grep 192.30.120.10

# Test local web access
echo "Testing local web access:"
curl -sI http://localhost:80 | head -n1
curl -sI http://192.30.120.10:80 | head -n1 || echo "Failed to connect to anycast IP on port 80"
curl -sI http://localhost:8001 | head -n1
EOF

echo "Web access configuration has been fixed on LAX server."
echo "You should now be able to access lg.infinitum-nihil.com in your browser."
echo "If you still have issues, make sure your DNS record points to 192.30.120.10."